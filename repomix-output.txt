This file is a merged representation of the entire codebase, combining all repository files into a single document.
Generated by Repomix on: 2025-04-20T19:40:04.890Z

================================================================
File Summary
================================================================

Purpose:
--------
This file contains a packed representation of the entire repository's contents.
It is designed to be easily consumable by AI systems for analysis, code review,
or other automated processes.

File Format:
------------
The content is organized as follows:
1. This summary section
2. Repository information
3. Directory structure
4. Multiple file entries, each consisting of:
  a. A separator line (================)
  b. The file path (File: path/to/file)
  c. Another separator line
  d. The full contents of the file
  e. A blank line

Usage Guidelines:
-----------------
- This file should be treated as read-only. Any changes should be made to the
  original repository files, not this packed version.
- When processing this file, use the file path to distinguish
  between different files in the repository.
- Be aware that this file may contain sensitive information. Handle it with
  the same level of security as you would the original repository.

Notes:
------
- Some files may have been excluded based on .gitignore rules and Repomix's
  configuration.
- Binary files are not included in this packed representation. Please refer to
  the Repository Structure section for a complete list of file paths, including
  binary files.

Additional Info:
----------------

================================================================
Directory Structure
================================================================
.cursor/
  rules/
    documentation.mdc
    instructions.mdc
.docs/
  auth.md
  dashboard-cleanup.md
  design.md
  prd.md
  prd2.md
  update.md
assets/
  css/
    global.css
    layout.css
components/
  auth/
    GoogleSignInButton.vue
  dashboard/
    Dashboard.vue
  ui/
    AppButton.vue
    AppCard.vue
    AppSpinner.vue
    ErrorBanner.vue
  LogoutButton.vue
composables/
  useDashboard.ts
layouts/
  default.vue
  minimal.vue
middleware/
  auth.global.ts
pages/
  auth/
    callback.vue
  index.vue
  login.vue
  settings.vue
public/
  google-logo.svg
  robots.txt
server/
  tsconfig.json
.gitignore
.repomixignore
app.vue
eslint.config.mjs
nuxt.config.ts
package.json
README.md
repomix.config.json
tsconfig.json

================================================================
Files
================================================================

================
File: .cursor/rules/documentation.mdc
================
---
description: Global documentation requirements
globs: 
alwaysApply: true
---
## Documentation Requirements

- After implementing each feature, update documentation in the `/.docs` directory; do not update requirements until user has confirmed feature is done
- Create or update a feature-specific Markdown file (e.g., `/.docs/design/feature4_steering-controls.md`)
- Documentation must include:
  - Mermaid diagrams showing the architecture/component relationships
  - Text descriptions explaining key concepts and design decisions
  - Function interaction diagrams (for complex features)
  - Any API interfaces or important type definitions
- Follow this structure for each feature document:
  1. Feature overview (brief description)
  2. Architecture diagram (Mermaid)
  3. Key components and their responsibilities
  4. Data flow explanation
  5. Function Call Graph (Mermaid) that:
     - Map how functions call each other within files and across the codebase
     - Visualize data flow between key functions
     - Highlight dependencies between different modules
     - Group related functions by color or container to show logical domains
     - Use Mermaid flowcharts with nodes representing functions and arrows showing call/data relationships
     - For complex features, include a separate "Function Call Graph" section with detailed interaction maps
  6. API documentation (if applicable)
  7. Implementation notes or considerations
- Link to relevant documentation in commit messages when submitting changes
- Include function interaction diagrams that:

================
File: .cursor/rules/instructions.mdc
================
---
description: Global rues across the codebase
globs: 
alwaysApply: true
---
# Cursor Rules

You are a senior Nuxt.js web developer. You write functional, DRY, performant, efficient code, which has both great design and also exceptional UX/UI.

## Core Principles

- Do not make any changes I have not asked for. If you want to make changes I have not asked for, add them to the todo.md for future consideration, unless they are urgent, then ask me what I think before making the changes.
- Use functional, declarative programming; avoid classes
- Follow DRY principles: pr5ioritize iteration and modularization, always extract reusable functions
- Maintain code readability by limiting files to approximately 200 lines of code; extract reusable functions into separate utility modules in a utils/ directory when a file approaches this limit
- Implement early error handling with guard clauses and early returns
- Always review ``.docs/prd.md` for context
- Add any outstanding/not completed work for what you're currently building to `.docs/todo.md`
- Add any proposed enhancements to `.docs/enhancements.md`
- After each feature is implemented, update a `.docs/design` which uses mermaid diagrams and text to describe how the codebase works
- Make sure the follow the best practices for maintaining a clean code architecture

## JavaScript

- Write clean, concise JavaScript
- Use `function` keyword for pure functions; omit semicolons
- For single-line conditional statements, omit curly braces: `if (!isValid) return`
- Avoid unnecessary `else` statements; use `if-return` pattern

## Vue 3 & Composition API

- Leverage Composition API (`ref`, `reactive`, `computed`); avoid Options API
- Implement custom composables for reusable logic
- Use provide/inject for dependency injection when appropriate
- Use Suspense for asynchronous components

## Nuxt 3 Framework

- Follow Nuxt 3 directory structure (`pages/`, `components/`, `composables/`, etc.)
- Leverage auto-imports for components, composables, and Vue APIs
- Use `useHead` and `useSeoMeta` for SEO optimization
- Server API routes in `server/api/` for backend operations
- Use `useRuntimeConfig` for environment-specific configuration

## CSS & Styling

- No inline CSS; use `<style scoped>` or external CSS files
- Implement responsive design with media queries
- Keep global reset styles in `assets/css/global.css`

## Project Structure

- Component files: PascalCase (e.g., `MyComponent.vue`)
- Composables: `use<MyComposable>` format with named exports
- Directories: lowercase with dashes (e.g., `components/auth-wizard`)
- Key directories:
  - `pages/`: Route-based components
  - `components/`: Reusable Vue components
  - `composables/`: Reusable logic
  - `layouts/`: Page layouts
  - `plugins/`: Nuxt plugins
  - `public/`: Static assets
  - `server/`: Server-side code and API endpoints
  - `assets/css/`: Global styles

## Performance Optimization

- Implement lazy loading for routes and components
- Optimize images: WebP format, size attributes, lazy loading
- Optimize Core Web Vitals (LCP, CLS, FID)
- Use Pinia for state management only when app-wide state is needed
- Leverage VueUse for common utility functions

================
File: .docs/auth.md
================
# Updated Requirements: Supabase Auth with Gmailâ€‘Readonly Scope

## 2.1.1 Authentication & Authorization (Revised)
1. **User Signâ€‘In**  
   - Single â€œSign in with Googleâ€ flow via SupabaseÂ Auth.  
   - Request scopes:  
     <code>openid email profile https://www.googleapis.com/auth/gmail.readonly</code>  
   - Implementation example:  
     <code>const { data, error } = await supabase.auth.signInWithOAuth({  
       provider: 'google',  
       options: {  
         scopes: 'openid email profile https://www.googleapis.com/auth/gmail.readonly'  
       }  
     })</code>  
   - On success, Supabase returns a session that includes <code>provider_token</code> for Gmail API calls.

2. **Token Management**  
   - Supabase Auth automatically handles token refresh.  
   - Access <code>supabase.auth.getSession()</code> or listen to <code>onAuthStateChange</code> to retrieve <code>provider_token</code> when needed.

---

## 4.X Frontâ€‘End Requirements

### Pages & Components

#### 1. Login Page (`/pages/login.vue`)
- **Components**  
  - `<GoogleSignInButton>` with Google icon and label â€œSign in with Googleâ€  
  - `<ErrorBanner>` to display authentication errors  
- **Behavior**  
  1. User clicks the Google button  
  2. Call <code>supabase.auth.signInWithOAuth(â€¦)</code>  
  3. Show loading spinner until redirect  
  4. After redirect to `/auth/callback`, complete signâ€‘in  

#### 2. OAuth Callback (`/pages/auth/callback.vue`)
- **Logic**  
  1. Call <code>await supabase.auth.getSessionFromUrl()</code>  
  2. If success â†’ navigate to `/dashboard`  
  3. If error â†’ display `<ErrorBanner>` with retry link  

#### 3. Dashboard (`/pages/dashboard.vue`)
- **Header**  
  - Display userâ€™s avatar and email from <code>supabase.auth.getUser()</code>  
  - `<LogoutButton>` calls <code>supabase.auth.signOut()</code>  
- **Main Content**  
  - **SubscriptionSummary** component showing total spend and upcoming renewals  
  - **SubscriptionList** component listing each vendor, amount, next renewal  
  - `<Button>` â€œRefresh Emailsâ€ to trigger Gmail fetch manually  

#### 4. Settings (`/pages/settings.vue`)
- **Sections**  
  - **Reâ€‘Consent Gmail Access**  
    - If the sessionâ€™s scopes donâ€™t include Gmail, show a banner with a â€œGrant Accessâ€ button that calls the same <code>signInWithOAuth</code> with extended scopes.  
  - **Session Info**  
    - Display granted scopes and token expiry from <code>supabase.auth.getSession()</code>.  

---

### UI States & Flows

1. **Not Authenticated**  
   - â†³ Render **Login Page**

2. **Authenticated but Missing Gmail Scope**  
   - â†³ On any page, show `<ScopeNotice>` banner with â€œGrant Gmail Accessâ€ button

3. **Authenticated & Gmail Scope Granted**  
   - â†³ Render **Dashboard** and allow full emailâ€‘parsing functionality

4. **Token Expired or Revoked**  
   - â†³ Supabase emits `SIGNED_OUT` â†’ redirect to **Login Page**

================
File: .docs/dashboard-cleanup.md
================
# DashboardÂ Unification & RoutingÂ Cleanup â€” **RequirementsÂ v1.0**

##Â 1Â Overview  
There are two competing dashboard implementations:

| File | Route | Status |
|------|-------|--------|
| <code>pages/index.vue</code> | <code>'/'</code> | âœ… Desired UI, correct CSS |
| <code>pages/dashboard.vue</code> | <code>'/dashboard'</code> | âŒ Outâ€‘ofâ€‘date styles, owns Gmailâ€‘sync JS |

This duplication causes an unâ€‘styled flash on first load (user is redirected to <code>/dashboard</code>), and splits logic between two views.

---

##Â 2Â Goals  
1. **Single sourceâ€‘ofâ€‘truth UI** â€” keep the styled markup now in <code>index.vue</code>.  
2. **Canonical dashboard routeÂ <code>'/'</code>** â€” all postâ€‘login redirects & nav links land here.  
3. **Shared logic** â€” expose Gmailâ€‘sync & state via a composable usable by any view/component.  
4. **DRY refreshâ€‘emails button** â€” any instance triggers the same composable action.  

---

##Â 3Â Functional Requirements  

|Â ID | Requirement | Notes |
|----|-------------|-------|
| **FRâ€‘01** | **Postâ€‘auth redirect âœ <code>'/'</code>** | Update <code>supabase.redirectOptions.callback</code> to <code>'/'</code> and any <code>navigateTo()</code> calls in <code>auth/callback.vue</code>. |
| **FRâ€‘02** | **Create composableÂ <code>useDashboard()</code>** | Houses Supabase session, Gmailâ€‘sync, subscription fetch, and UI state (<code>isLoading</code>, <code>syncStatus</code>, etc.). |
| **FRâ€‘03** | **Move dashboard markup to new component** | Extract entire template + scoped CSS from <code>index.vue</code> into **<code>components/dashboard/Dashboard.vue</code>** (or reuse/rename old <code>pages/dashboard.vue</code>). |
| **FRâ€‘04** | **Refactor <code>pages/index.vue</code>** | Acts as thin wrapper that: <br>Â Â â€¢ imports <code>&lt;Dashboard /&gt;</code><br>Â Â â€¢ renders it if session OK<br>Â Â â€¢ else shows landing hero. |
| **FRâ€‘05** | **Remove/repurpose <code>pages/dashboard.vue</code>** | Either delete to avoid duplicate route or convert to stub that forwards to <code>'/'</code> via <code>navigateTo('/')Â </code>. |
| **FRâ€‘06** | **Refreshâ€‘emails button uses composable** | All buttons call <code>const { refreshEmails } = useDashboard()</code>. |

---

##Â 4Â ArchitectureÂ Updates  

###Â 4.1Â Directory & Route Map (After Refactor)

| Layer | File | Responsibility |
|-------|------|----------------|
| **Page (root)** | <code>pages/index.vue</code> | Landing âœ¦ Authâ€‘protected wrapper that mounts dashboard component. |
| **Component** | <code>components/dashboard/Dashboard.vue</code> | Entire dashboard UI (template + CSS). |
| **Composable** | <code>composables/useDashboard.ts</code> | Handles Supabase user, Gmail scope checks, Gmail sync, querying subscription data. |
| **Auth Callback** | <code>pages/auth/callback.vue</code> | On success âœ <code>navigateTo('/')Â </code>. |

###Â 4.2Â ComposableÂ APIÂ (contract)

<code>
export function useDashboard () {
  // STATE
  const user        = useSupabaseUser()
  const isLoading   = ref(false)
  const syncStatus  = ref('')
  const subscriptions = ref([])

  // ACTIONS
  async function refreshEmails () { â€¦ }   // POST /api/gmail/sync
  async function loadSubscriptions () { â€¦ }

  // INIT
  watchEffect(() => { if (user.value) loadSubscriptions() })

  return { user, isLoading, syncStatus, subscriptions, refreshEmails }
}
</code>

The composable **does not** touch routing or presentation; each view decides how to display state.

---

##Â 5Â TechnicalÂ Design  

###Â 5.1Â Redirect Flow  
1. User finishes OAuth in <code>auth/callback.vue</code>.  
2. PKCE exchange completes â†’ <code>useSupabaseUser()</code> becomes truthy.  
3. Callback page immediately runs <code>navigateTo('/')Â </code>.  
4. GlobalÂ <code>auth.global.ts</code> middleware already guards private routes; no change needed.

###Â 5.2Â pages/index.vue (wrapper template)

<code>
&lt;template&gt;
  &lt;div&gt;
    &lt;Dashboard v-if="user" /&gt;
    &lt;LandingHero v-else /&gt;
  &lt;/div&gt;
&lt;/template&gt;

&lt;script setup&gt;
import { useSupabaseUser } from '#imports'
import Dashboard from '@/components/dashboard/Dashboard.vue'
import LandingHero from '@/components/landing/Hero.vue'

const user = useSupabaseUser()
&lt;/script&gt;
</code>

###Â 5.3Â Dashboard Component

Import composable and wire buttons:

<code>
&lt;script setup&gt;
import { useDashboard } from '@/composables/useDashboard'

const { subscriptions, isLoading, syncStatus, refreshEmails } = useDashboard()
&lt;/script&gt;
â€¦
&lt;AppButton @click="refreshEmails" :disabled="isLoading"&gt;Refresh Emails&lt;/AppButton&gt;
</code>

###Â 5.4Â Handling Legacy Route

OptionÂ AÂ (recommended): delete <code>pages/dashboard.vue</code>.  
OptionÂ B: keep it, but inside:

<code>
export default defineNuxtRouteMiddleware(() =&gt; navigateTo('/'))
</code>

---

##Â 6Â MigrationÂ Steps  

1. **Create composable** <code>composables/useDashboard.ts</code> and move JS from both pages.  
2. **Extract** template + CSS from <code>pages/index.vue</code> into <code>components/dashboard/Dashboard.vue</code>.  
3. **Refactor** <code>pages/index.vue</code> to wrapper shown above.  
4. **Update redirects** in <code>supabase.redirectOptions.callback</code> (in <code>nuxt.config.ts</code>) and in <code>auth/callback.vue</code>.  
5. **RemoveÂ dup route** (<code>pages/dashboard.vue</code>) or redirect to root.  
6. **Ensure navbar** link already points to <code>'/'</code> (no change).  
7. **QA**:  
   * Signâ€‘in flow lands on styled dashboard.  
   * Refresh emails button works on dashboard.  
   * Direct navigation to <code>/dashboard</code> (if kept) redirects/forwards correctly.  

---

##Â 7Â OpenÂ Questions / Confirmation Needed  

* Should we **delete** <code>pages/dashboard.vue</code> entirely (preferred) or keep as redirect stub?  
* Any other feature flags or pageâ€‘level middleware that assume route <code>'/dashboard'</code>?  

Please confirm or adjust before implementation.

================
File: .docs/design.md
================
# UI/UX Requirements (VanillaÂ CSS)

## 1. Design Principles
- **Clean & Minimal**  
  Use plain CSS (no frameworks). Leverage white space, clear typography, and simple layouts.  
- **Modern & Animated**  
  Subtle CSS transitions and keyframe animations to enhance feedback (e.g., button hovers, card fades).  
- **Responsive & Inclusive**  
  Mobileâ€‘first media queries and fluid layouts; accessible colors & focus styles.  
- **Consistent & Predictable**  
  Reuse CSS variables for colors, spacing, typography; follow a naming convention (e.g. BEM or utility classes).

---

## 2. Global Layout & Navigation
1. **Header**  
   - Fixed at top, flexâ€‘box layout  
   - Logo on left, nav links in center, user avatar on right  
   - Simple hover underline animations on links
2. **Main Content Area**  
   - Centered container (max-width: 1200px)  
   - 12â€‘column grid via CSS Grid for desktop; single column on mobile  
3. **Footer (optional)**  
   - Centered text, small font, muted color  

---

## 3. Page Flows & Wireframes

### 3.1 Login Page  
- **Hero Section:**  
  - Heading, subheading  
  - Centered `<button>` with Google icon  
  - CSS transition on hover (backgroundâ€color, boxâ€shadow)  
- **Error State:**  
  - Inline alert `<div>` with slideâ€down animation  

### 3.2 OAuth Callback  
- **Fullâ€Screen Loader:**  
  - Centered spinner using CSS keyframes  
  - Message: â€œSigning you inâ€¦â€  

### 3.3 Dashboard  
- **Header Bar:**  
  - Prominent total spend `<h1>`  
  - `<button>` â€œRefresh Emailsâ€ with ripple effect on click  
- **Sections:**  
  1. **Spending Overview Card**  
     - Fadeâ€in on load  
  2. **Upcoming Renewals**  
     - Table or card list; row hover highlight  
  3. **Category Breakdown**  
     - Simple bar/pie chart placeholder (can be SVG or Canvas)  
- **Empty State:**  
  - Illustrated SVG or CSS drawing + subtle bounce animation  

### 3.4 Subscription List  
- **Item Layout:**  
  - Flex layout: icon, text, next date, action icon  
  - â€œIgnoreâ€ icon with rotateâ€onâ€hover animation  

### 3.5 Settings  
- **Forms & Controls:**  
  - Styled `<input>`, `<select>`, and radio buttons with focus ring transitions  
  - Banner to reâ€‘grant Gmail access with slideâ€in animation  

### 3.6 Digest Preview (Modal)  
- **Modal Overlay:**  
  - Semiâ€‘opaque backdrop  
  - Modal card slides down on open, slides up on close  

---

## 4. Components & Interactions

| Component                 | Vanilla CSS Notes                                                 |
|---------------------------|-------------------------------------------------------------------|
| `<button>`                | Reset browser styles; padding, borderâ€radius, transition on hover |
| `<card>` (div.container)  | White background, boxâ€shadow, borderâ€radius, padding              |
| `<input>`                 | Borderâ€bottom highlight on focus, transition                       |
| `.spinner`                | `<div>` with CSS keyframes for rotation                           |
| `.alert`                  | Red background, fadeâ€in/out, role="alert"                         |
| `.modal`                  | Fixed position, opacity transition, transform for slide effect     |

---

## 5. Style Guide

- **CSS Variables** (in :root):  
  <code>:root {  
    --color-bg: #ffffff;  
    --color-text: #1f2937;  
    --color-accent: #4f46e5;  
    --space-sm: 8px;  
    --space-md: 16px;  
    --space-lg: 24px;  
    --font-base: 16px;  
  }</code>

- **Colors**  
  - Background: <code>var(--color-bg)</code>  
  - Text: <code>var(--color-text)</code>  
  - Accent (buttons, links): <code>var(--color-accent)</code>  
- **Typography**  
  - Base font-size: <code>var(--font-base)</code> (1rem)  
  - Headings: scale 1.5â€“2rem, font-weight 600â€“700  
- **Spacing**  
  - Use <code>var(--space-*)</code> for margin/padding  

---

## 6. Accessibility & Responsiveness

- **Keyboard Navigation**  
  - Ensure `<button>` and `<a>` have visible focus styles  
- **ARIA Attributes**  
  - `<div role="alert">` for errors; `<div aria-busy="true">` during loads  
- **Media Queries**  
  <code>@media (min-width: 640px) { â€¦ }</code> mobile â†’ tablet  
  <code>@media (min-width: 1024px) { â€¦ }</code> tablet â†’ desktop  

---

## 7. Developer Handoff

- Provide simple HTML/CSS prototypes or code snippets  
- Share CSS variable file and reset stylesheet  
- Include comments in CSS for component sections and animations

================
File: .docs/prd.md
================
# Requirements, Architecture, and Technical Design with Supabase

## 1. Introduction

This document outlines the requirements and technical design for a subscription-tracking web application built with **Nuxt.js**. The application will connect to a userâ€™s Gmail account (via OAuth) to parse subscription-related emails, categorize them, calculate total subscription costs, and provide digest notifications. **In this iteration, we use [Supabase](https://supabase.com/) as the backend for both database and authentication layers.**

## 2. Requirements

### 2.1 Functional Requirements (MVP)
1. **User Authentication & Authorization**
   - Users can sign in with Google (OAuth 2.0).
   - Read-only access to Gmail (scope: <code>https://www.googleapis.com/auth/gmail.readonly</code>).
   - Optionally, leverage Supabase Auth (if needed) for additional security or user management features.

2. **Email Parsing**
   - Search emails for subscription-related keywords (<code>"subscription", "receipt", "invoice", "payment"</code>).
   - Extract relevant data:
     - Sender
     - Subject
     - Date
     - Amount
     - Vendor Name
   - Use regex or an LLM-based approach to parse the email bodies for key values (amount, subscription date, etc.).

3. **Basic Categorization**
   - Hardcode vendor-to-category mapping (e.g., Netflix â†’ â€œStreamingâ€).
   - Store category along with subscription info.

4. **Dashboard View**
   - Display:
     - Total monthly spending
     - List of subscriptions: vendor, amount, renewal cycle, next due date
   - Allow user to see aggregated data by category or vendor.

5. **Digest Delivery**
   - Send digest notifications via email or in-app message.
   - Digest includes:
     - Total spend in the current month
     - Breakdown by category and vendor
     - Upcoming renewal dates

6. **User Settings**
   - User can select digest frequency (weekly or monthly).
   - User can ignore (or remove) certain subscriptions.

### 2.2 Nice-to-Have Features (Future Enhancements)
1. **Automatic Renewal Cycle Detection**  
   - Infer monthly, yearly, or other intervals from email content and patterns.
2. **More Sophisticated Categorization**  
   - ML or advanced rule-based system for vendor categorization.
3. **Analytics & Charts**  
   - Historical spending trends and interactive charts.
4. **Mobile App/PWA**  
   - Provide push notifications for upcoming renewals.
5. **Multi-Email Support**  
   - Connect multiple Gmail accounts to one user profile.

### 2.3 Non-Functional Requirements
1. **Security**  
   - Use Supabase Auth for storing user tokens securely (or handle within your own system).
2. **Performance**  
   - Optimized queries and background jobs to handle email parsing efficiently.
3. **Scalability**  
   - Supabase scales with the project (Postgres under the hood, horizontally scalable).
4. **Maintainability**  
   - Modular architecture for adding more categories, data models, or email parsing rules in the future.

---

## 3. High-Level Architecture

1. **Client (Nuxt.js)**  
   - UI for user interactions, dashboards, and settings.
   - Integration with Gmail OAuth flow and Supabase Auth.

2. **Supabase**  
   - **Database**: PostgreSQL managed by Supabase.
   - **Auth**: (Optional) use Supabase Auth for session management or integrate your own Google OAuth with Gmail read-only scope.
   - **API / Edge Functions**: If needed, use Supabaseâ€™s Edge Functions for serverless logic (e.g., digest scheduling, email parsing).

3. **Gmail API**  
   - OAuth 2.0 for secure access to read emails.
   - Gmail REST API to fetch and parse incoming messages.

4. **Scheduled/Background Jobs**  
   - Could be implemented using Supabase Edge Functions + cron triggers or an external CRON-based system for digest sending and email scanning.

5. **Email Delivery**  
   - Use an email service (SendGrid, AWS SES, or Gmail API) to send digests and notifications.

---

## 4. Technical Design

### 4.1 Technology Stack
- **Front End**: Nuxt.js (Vue 3, optional TypeScript).
- **Supabase**:
  - **Database**: PostgreSQL (managed by Supabase).
  - **Auth**: Use Supabaseâ€™s built-in Auth or keep user tokens yourself.
  - **Edge Functions**: For serverless functionality if needed.
- **Authentication**: Google OAuth 2.0 (for Gmail).
- **Email Parsing**: Gmail API, plus regex or LLM approach.
- **Email Delivery**: Third-party service or Gmail API for sending.

### 4.2 Data Flow Overview
1. **User Signs In**  
   - Via Google OAuth or Supabase Auth (depending on setup).
   - On success, userâ€™s data is stored in Supabase DB or just session data is stored.  
2. **Email Retrieval**  
   - Use the Gmail API with the userâ€™s tokens to fetch messages containing relevant keywords.
3. **Parsing & Categorization**  
   - Identify subscription info in messages.
   - Store in Supabase table with vendor, amount, next renewal, etc.
4. **Dashboard & Digest**  
   - Show aggregated data in Nuxt.js UI.
   - Generate and email periodic digests to the user.

### 4.3 Supabase Database Structure

*(See next code block for exact CREATE TABLE queries.)*

- **Users Table**  
  Stores user profile details and possibly links to Supabase Auth ID or Google ID.
- **Subscriptions Table**  
  Holds user subscriptions with vendor details, amounts, next renewal, category, etc.
- **Email Logs Table**  
  Optionally store raw email references or parsed info for debugging.

### 4.4 Gmail Integration
1. **OAuth 2.0 Flow**  
   - Obtain read-only access token for Gmail.
   - Store tokens in Supabase or rely on ephemeral token usage.  
2. **Messages Fetch**  
   - Use the Gmail API (`/gmail/v1/users/{userId}/messages`) with query params like `<code>subscription OR receipt OR invoice OR payment</code>`.
3. **Parsing Logic**  
   - Regex to detect amounts, vendor names, subscription dates.
   - Or use an LLM-based approach.

### 4.5 Categorization
- Define a dictionary for vendor-to-category mapping.
- Example:
  <code>{
    "Netflix": "Streaming",
    "Spotify": "Music",
    ...
  }</code>
- Default to â€œUncategorizedâ€ if no match.

### 4.6 Dashboard & UI
1. **Login Page**  
   - Google OAuth or Supabase Auth.  
2. **Main Dashboard**  
   - Monthly subscription totals, upcoming renewals, vendor list.  
3. **Settings**  
   - Update digest frequency, exclude or ignore subscriptions.

### 4.7 Digest Delivery
1. **Frequency**  
   - Weekly or monthly, configured per user.  
2. **Scheduler**  
   - Could use Supabaseâ€™s [Scheduled Triggers](https://supabase.com/docs/guides/database/scheduled-triggers) or an external service to run daily checks.  
3. **Notification**  
   - Summarize monthly spend, breakdown, upcoming renewals.  
   - Send email via a third-party service or directly via Gmail API.

### 4.8 Implementation Steps
1. **Nuxt.js Setup**: `npx nuxi init subscription-tracker`  âœ… COMPLETE
2. **Supabase Project**  âœ… COMPLETE
   - Create a new project on supabase.com.  
   - Get project URL, anon key, service role key, etc.  
3. **Database & Tables**  âœ… COMPLETE
   - Use the provided SQL to create tables.  
4. **Configure Supabase Client** in Nuxt  âœ… COMPLETE
   - Install `@supabase/supabase-js`.  
   - Provide your `SUPABASE_URL` and `SUPABASE_ANON_KEY`.  
5. **OAuth Integration**  
   - If youâ€™re using Google OAuth for Gmail in addition to Supabase Auth, ensure to handle token storage.  
6. **Gmail Parsing & Subscription Handling**  
   - Implement the fetch + parse logic, store results in Supabase.  
7. **Digest Scheduling**  
   - Use Supabase Scheduled Triggers or external cron.  
8. **UI/UX Polishing & Testing**.

---

## 5. Supabase SQL Queries

<code>
-- USERS TABLE
CREATE TABLE users (
  id uuid DEFAULT gen_random_uuid() PRIMARY KEY,
  google_id text UNIQUE,
  email text NOT NULL,
  digest_frequency text DEFAULT 'monthly',
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now()
);

-- SUBSCRIPTIONS TABLE
CREATE TABLE subscriptions (
  id uuid DEFAULT gen_random_uuid() PRIMARY KEY,
  user_id uuid REFERENCES users (id) ON DELETE CASCADE,
  vendor_name text,
  category text,
  amount numeric(10,2),
  currency text DEFAULT 'USD',
  next_renewal_date date,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now()
);

-- EMAIL LOGS TABLE
CREATE TABLE email_logs (
  id uuid DEFAULT gen_random_uuid() PRIMARY KEY,
  user_id uuid REFERENCES users (id) ON DELETE CASCADE,
  gmail_message_id text,
  extracted_amount numeric(10,2),
  vendor_name text,
  subscription_date timestamp with time zone,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now()
);
</code>

================
File: .docs/prd2.md
================
# Requirements, Architecture & Technical Design  
### *SubscriptionÂ Tracker â€” Supabaseâ€‘only GoogleÂ Auth Edition*  

---

##Â 1Â Introduction  

This NuxtÂ 3 web application tracks recurring payments by reading a userâ€™s Gmail inbox.  
All authentication and Gmail access are handled **exclusively** by **SupabaseÂ Auth** (Google provider).  
The Gmail address chosen at signâ€‘in is the same mailbox read with scope  
<code>https://www.googleapis.com/auth/gmail.readonly</code>.  
No other OAuth flow or provider is supported in this iteration.

---

##Â 2Â Requirements  

###Â 2.1Â Functional RequirementsÂ (MVP)  

|Â ID | Requirement | Notes |
| --- | --- | --- |
| **FRâ€‘01** | **GoogleÂ Signâ€‘in via SupabaseÂ Auth** | Scope: <code>openid email profile https://www.googleapis.com/auth/gmail.readonly</code>. One consent screen grants signâ€‘in **and** Gmail readâ€‘only. |
| **FRâ€‘02** | **Immediate GmailÂ Sync** | After first login, backend enqueues <code>syncGmail()</code> to pull the latest threads. |
| **FRâ€‘03** | **EmailÂ Parsing** | Query: <code>"subscription" OR "receipt" OR "invoice" OR "payment"</code>. Extract sender, subject, date, amount, vendor. Regex first; LLM later. |
| **FRâ€‘04** | **BasicÂ Categorization** | Hardâ€‘coded vendorâ†’category map (NetflixÂ â†’Â Streaming, etc.). |
| **FRâ€‘05** | **Dashboard** | Shows totals, renewals, breakdown. Data served by REST; UI never calls Gmail. |
| **FRâ€‘06** | **DigestÂ Notifications** | Weekly / monthly email or inâ€‘app digest with spend summary. |
| **FRâ€‘07** | **UserÂ Settings** | Digest frequency, ignore subscriptions, revoke / reâ€‘grant Gmail scope. |

###Â 2.2Â Niceâ€‘toâ€‘Have (Deferred)  

* Renewalâ€‘cycle inference, ML categorization, historical charts, PWA push, multiâ€‘email support.  

###Â 2.3Â Nonâ€‘Functional Requirements  

| Category | Detail |
| --- | --- |
| **Security** | Supabase stores OAuth refresh tokens; Edge Function uses perâ€‘user rowâ€‘level security. |
| **Performance** | Gmail fetch & parse in Edge Function; dashboard hits preâ€‘aggregated SQL view. |
| **Scalability** | Supabase Postgres + stateless Edge Functions; cron can scale horizontally. |
| **Maintainability** | Domain logic in composables / server utils; â‰¤Â 200Â LOC per file. |

---

##Â 3Â Highâ€‘Level Architecture  

| Layer | Responsibility |
| --- | --- |
| **NuxtÂ Client** | UI & routing, calls backend REST, never touches Gmail directly. |
| **SupabaseÂ Auth** | Google provider, token refresh, exposes <code>provider_token</code>. |
| **SupabaseÂ DB** | Tables: <code>users</code>, <code>subscriptions</code>, <code>email_logs</code>. |
| **Edge FunctionÂ syncGmail** | Pulls, parses, stores Gmail data; triggered on login & nightly cron. |
| **RESTÂ API** | <code>/api/subscriptions/summary</code>, <code>/api/subscriptions/list</code>, etc. |
| **DigestÂ Scheduler** | Cron checks who needs digests; sends email via SendGrid. |
| **GmailÂ API** | Readâ€‘only access using Supabaseâ€‘issued <code>provider_token</code>. |

---

##Â 4Â Technical Design  

###Â 4.1Â Authentication Flow  

<code>
1. Client âœ supabase.auth.signInWithOAuth  
   â€¢ scopes: openid email profile https://www.googleapis.com/auth/gmail.readonly  
2. Google consent (single screen).  
3. RedirectÂ âœ /auth/callback.  
4. Page calls supabase.auth.getSessionFromUrl().  
5. Session now contains provider_token + refresh_token.  
6. Server hook enqueues syncGmail(userId) immediately.  
</code>

###Â 4.2Â Data Flow Diagram (Mermaid)  

<code>
flowchart LR
  A[User Login] --> B(Supabase Auth\nGoogle Provider)
  B -->|session + provider_token| C(Nuxt Client)
  C -->|enqueue| D[Edge Function syncGmail]
  D --> E(Gmail API)
  E --> D
  D --> F(Supabase DB)
  F --> G[/api/subscriptions/summary]
  G --> C
  F --> H(Digest Scheduler)
  H --> I(SendGrid)
</code>

###Â 4.3Â Edge FunctionÂ syncGmail()Â Algorithm  

<code>
1. Verify event source (login trigger or nightly cron).  
2. Fetch provider_token from Supabase for userId.  
3. Gmail users.messages.list with query string.  
4. For each message ID:  
   â€¢ users.messages.get (metadata only)  
   â€¢ regex parse amount, vendor, renewal date  
5. Upsert into subscriptions; insert into email_logs.  
6. If Gmail scope revoked â‡’ mark user.needs_regrant = true.  
</code>

###Â 4.4Â Database Schema  

<code>
-- USERS  
CREATE TABLE users (
  id uuid PRIMARY KEY DEFAULT gen_random_uuid(),
  google_id text UNIQUE,
  email text NOT NULL,
  digest_frequency text DEFAULT 'monthly',
  needs_regrant boolean DEFAULT false,
  created_at timestamptz DEFAULT now(),
  updated_at timestamptz DEFAULT now()
);

-- SUBSCRIPTIONS  
CREATE TABLE subscriptions (
  id uuid PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id uuid REFERENCES users(id) ON DELETE CASCADE,
  vendor_name text,
  category text,
  amount numeric(10,2),
  currency text DEFAULT 'USD',
  next_renewal_date date,
  created_at timestamptz DEFAULT now(),
  updated_at timestamptz DEFAULT now()
);

-- EMAIL_LOGS  
CREATE TABLE email_logs (
  id uuid PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id uuid REFERENCES users(id) ON DELETE CASCADE,
  gmail_message_id text,
  extracted_amount numeric(10,2),
  vendor_name text,
  subscription_date timestamptz,
  created_at timestamptz DEFAULT now(),
  updated_at timestamptz DEFAULT now()
);
</code>

---

##Â 5Â Frontâ€‘End Specification  

###Â 5.1Â Pages & Key Components  

| Page | Components | States |
| --- | --- | --- |
| **/login** | <code>&lt;GoogleSignInButton&gt;</code>, <code>&lt;ErrorBanner&gt;</code> | idle, loading, error |
| **/auth/callback** | <code>&lt;AppSpinner&gt;</code> | processing, error |
| **/** (dashboard) | header (avatar, email, logout) Â· <code>&lt;SubscriptionSummary&gt;</code> Â· <code>&lt;SubscriptionList&gt;</code> Â· chart placeholder | loading, data, empty |
| **/settings** | <code>&lt;DigestPrefsForm&gt;</code> Â· <code>&lt;GmailAccessCard&gt;</code> | normal, needsReGrant |

###Â 5.2Â UIÂ States & Routing Rules  

| Condition | Behaviour |
| --- | --- |
| No Supabase session | Redirect to **/login** |
| Session but Gmail scope revoked | Global <code>&lt;ScopeNotice&gt;</code> with â€œGrant Gmail Accessâ€ |
| Session OK | Normal navigation |
| Supabase emits SIGNED_OUT | Force logout âœ /login |

---

##Â 6Â Backend RESTÂ API Contract  

| Route | Method | Purpose |
| --- | --- | --- |
| /api/subscriptions/summary | GET | Returns totals, category & vendor aggregates, next renewals. |
| /api/subscriptions/list | GET | Paginated raw subscription rows. |
| /api/digest/trigger | POST | (Admin) trigger digest email manually. |

All routes require the Supabase JWT from <code>Authorization: Bearer &lt;token&gt;</code>.

---

##Â 7Â Implementation Checklist  

1. Nuxt scaffoldÂ âœ…  
2. Supabase projectÂ + env keysÂ âœ…  
3. DB migrationsÂ âœ…  
4. Supabase Auth (Google) with Gmail scopeÂ âœ…  
5. Supabase client pluginÂ âœ…  
6. Login / callback / dashboard / settings pagesÂ ğŸ”²  
7. Edge FunctionÂ syncGmail()Â ğŸ”²  
8. REST endpointsÂ ğŸ”²  
9. Digest scheduler & SendGrid integrationÂ ğŸ”²  
10. Unit & E2E testsÂ ğŸ”²  
11. Deployment pipelineÂ ğŸ”²  

---

##Â 8Â Open Questions / Future Work  

* LLM parser cost vs. accuracy.  
* Stripe webhook support for receipts outside Gmail.  
* UX for linking multiple mailboxes.  

---

*End of authoritative requirements. Modify this document before implementing any change.*

================
File: .docs/update.md
================
# AuthÂ &Â Navbar UXÂ Update â€” RequirementsÂ v1.0

## 1Â Overview  
Unify Google signâ€‘in across the app, keep the UI reactive to the Supabase session, and ensure the GmailÂ readâ€‘only OAuth scope is granted.

---

## 2Â Functional Requirements

| ID | Requirement | Details |
|----|-------------|---------|
| **FRâ€‘01** | **Single OAuth entry point** | Both the **Login** link in the navbar and the **SignÂ in withÂ Google** button on the landing page call <code>supabase.auth.signInWithOAuth({ provider: 'google', options: { scopes: 'openid email profile https://www.googleapis.com/auth/gmail.readonly' } })</code>. |
| **FRâ€‘02** | **Sessionâ€‘aware navbar** | After a successful redirect the navbar replaces **Login** with the userâ€™s <code>session.user.email</code> and shows a **Logout** button. When <code>useSupabaseUser()</code> is <code>null</code>, the navbar reverts to **Login**. |
| **FRâ€‘03** | **Landing page state** | â€¢ If signedÂ out: hero + **SignÂ in withÂ Google** button.<br>â€¢ If signedÂ in: hero/button hidden, dashboard grid rendered. |
| **FRâ€‘04** | **Route protection** | Authâ€‘only routes redirect to <code>/login</code> when <code>useSupabaseUser().value</code> is <code>null</code>. |
| **FRâ€‘05** | **LogÂ out flow** | Clicking **Logout** triggers <code>supabase.auth.signOut()</code> and navigates to <code>/login</code>. |
| **FRâ€‘06** | **Session persistence** | On refresh Nuxt hydrates the stored session so no flash of the loggedâ€‘out state appears. |

---

## 3Â Userâ€‘Experience & UI

### 3.1 Navbar (layouts/default.vue)

| State | Elements |
|-------|----------|
| **SignedÂ out** | Logo Â· optional nav links Â· **Login** link |
| **SignedÂ in** | Logo Â· nav links Â· <code>&lt;user.email&gt;</code> label Â· **Logout** |

### 3.2 LandingÂ (/pages/index.vue)

| State | Behaviour |
|-------|-----------|
| **SignedÂ out** | Hero + **SignÂ in withÂ Google** button |
| **SignedÂ in** | Dashboard grid (same as <code>/dashboard</code>) |

---

## 4Â Technical Design

### 4.1 Composables
<code>
const user = useSupabaseUser()  
const supabase = useSupabaseClient()
</code>

### 4.2 Navbar logic
<code>
const login = () =&gt; supabase.auth.signInWithOAuth({  
Â Â provider: 'google',  
Â Â options: { scopes: 'openid email profile https://www.googleapis.com/auth/gmail.readonly' }  
})  
const logout = () =&gt; supabase.auth.signOut()
</code>

### 4.3 Global middleware (middleware/auth.global.ts)
<code>
export default defineNuxtRouteMiddleware(() =&gt; {  
Â Â const user = useSupabaseUser()  
Â Â const path = useRoute().path  
Â Â const publicPages = ['/login', '/auth/callback']  
Â Â if (!user.value && !publicPages.includes(path)) return navigateTo('/login')  
})
</code>

### 4.4 Landingâ€‘page switch
<code>
const showDashboard = computed(() =&gt; !!useSupabaseUser().value)
</code>

---

## 5Â Nonâ€‘Functional Requirements
* **Accessibility**Â â€“ buttons have aria labels and focus rings.  
* **Performance**Â â€“ prevent flicker by rendering only after session hydration.  
* **Security**Â â€“ logout clears any cached Gmail data.

---

## 6Â OpenÂ Tasks
1. Remove hardâ€‘coded <code>ref(null)</code> user stubs from layouts/pages.  
2. Convert existing <code>Login.vue</code> to a minimal wrapper (optional).  
3. Unit tests for navbar state, middleware redirects.  
4. Update <code>.docs/auth.md</code> & <code>.docs/design.md</code> accordingly.

================
File: assets/css/global.css
================
/* Basic Reset */
*,
*::before,
*::after {
  box-sizing: border-box;
  margin: 0;
  padding: 0;
}

html {
  font-size: 32px; /* Set root font size to double the default (16px) */
}

html,
body {
  height: 100%;
}

body {
  line-height: 1.5;
  -webkit-font-smoothing: antialiased;
  font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
  background-color: var(--color-bg);
  color: var(--color-text);
  font-size: 1rem; /* Ensure body text uses the new root font size */
}

img, picture, video, canvas, svg {
  display: block;
  max-width: 100%;
}

input, button, textarea, select {
  font: inherit;
}

p, h1, h2, h3, h4, h5, h6 {
  overflow-wrap: break-word;
}

a {
  color: inherit;
  text-decoration: none;
}

/* CSS Variables */
:root {
  --color-bg: #ffffff;
  --color-text: #1f2937;
  --color-accent: #4f46e5;
  --color-accent-hover: #4338ca;
  --color-muted: #6b7280;
  --color-border: #e5e7eb;
  --color-error-bg: #fee2e2;
  --color-error-text: #b91c1c;

  --space-xs: 0.25rem;  /* 4â€“5 px */
  --space-sm: 0.5rem;   /* 8â€“10 px */
  --space-md: 1rem;     /* 16â€“20 px */
  --space-lg: 1.5rem;   /* 24â€“30 px */
  --space-xl: 2rem;     /* 32â€“40 px */
  --space-2xl: 3rem;    /* 48â€“60 px */

  /* Fonts (adjust if you want bigger) */
  --font-sm: 0.875rem;
  --font-lg: 1.125rem;
  --font-xl: 1.25rem;
  --font-2xl: 1.5rem;
  --font-3xl: 1.875rem;


  /* Adjusted border-radius slightly */
  --border-radius-sm: 6px;
  --border-radius-md: 12px;  /* was 8px */
  --border-radius-lg: 24px;  /* was 16px */

  --box-shadow: 0 2px 6px 0 rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1); /* Adjusted slightly */
  --box-shadow-md: 0 8px 12px -2px rgb(0 0 0 / 0.1), 0 4px 8px -4px rgb(0 0 0 / 0.1); /* Adjusted slightly */
  --box-shadow-lg: 0 20px 30px -6px rgb(0 0 0 / 0.1), 0 8px 12px -8px rgb(0 0 0 / 0.1); /* Adjusted slightly */

  --transition-duration: 150ms;
  --transition-timing: ease-in-out;
}

================
File: assets/css/layout.css
================
.app-layout {
    display: flex;
    flex-direction: column;
    min-height: 100vh;
  }
  
  .container {
    width: 100%;
    max-width: 70%;
    margin-left: auto;
    margin-right: auto;
    padding-left: var(--space-md);
    padding-right: var(--space-md);
  }
  
  .app-header {
    position: sticky; /* Make header fixed if desired */
    top: 0;
    z-index: 10;
    background-color: var(--color-bg);
    border-bottom: 1px solid var(--color-border);
    padding-top: var(--space-md);
    padding-bottom: var(--space-md);
    box-shadow: var(--box-shadow);
  }
  
  .header-container {
    display: flex;
    justify-content: space-between;
    align-items: center;
  }
  
  .logo {
    font-weight: 700;
    font-size: var(--font-xl);
    color: var(--color-accent);
  }
  
  .navigation a {
    margin: 0 var(--space-md);
    color: var(--color-text);
    position: relative;
    padding-bottom: var(--space-xs);
    transition: color var(--transition-duration) var(--transition-timing);
  }
  
  .navigation a::after {
    content: '';
    position: absolute;
    bottom: 0;
    left: 0;
    width: 100%;
    height: 2px;
    background-color: var(--color-accent);
    transform: scaleX(0);
    transform-origin: bottom right;
    transition: transform var(--transition-duration) var(--transition-timing);
  }
  
  .navigation a:hover,
  .navigation a.router-link-exact-active {
    color: var(--color-accent);
  }
  
  .navigation a:hover::after,
  .navigation a.router-link-exact-active::after {
    transform: scaleX(1);
    transform-origin: bottom left;
  }
  
  .user-profile {
    font-size: var(--font-sm);
    color: var(--color-muted);
  }
  
  .user-profile a:hover,
  .user-profile button:hover {
    opacity: 0.8;
  }
  
  .login-button,
  .logout-button {
    background: none;
    border: none;
    color: var(--color-accent);
    text-decoration: underline;
    text-underline-offset: 2px;
    cursor: pointer;
    font-size: inherit;
    padding: 0;
    margin-left: var(--space-sm);
  }
  
  .main-content {
    flex-grow: 1;
    padding-top: var(--space-xl);
    padding-bottom: var(--space-xl);
  }
  
  .app-footer {
    background-color: var(--color-bg);
    border-top: 1px solid var(--color-border);
    padding: var(--space-md) 0;
    margin-top: var(--space-2xl);
    text-align: center;
    font-size: var(--font-sm);
    color: var(--color-muted);
  }
  
  /* Responsive adjustments */
  @media (max-width: 768px) {
    .navigation {
      display: none; /* Simple hide for mobile, can implement burger menu later */
    }
    .header-container {
      justify-content: space-between;
    }
  }

================
File: components/auth/GoogleSignInButton.vue
================
<template>
  <button
    @click="$emit('click')"
    class="google-signin-button"
  >
    <!-- Placeholder for Google Icon -->
    <span class="google-icon">G</span>
    Sign in with Google
  </button>
</template>

<script setup>
defineEmits(['click'])
</script>

<style scoped>
.google-signin-button {
  display: inline-flex;
  align-items: center;
  justify-content: center;
  padding: var(--space-sm) var(--space-lg);
  border: 1px solid transparent;
  font-size: var(--font-sm);
  font-weight: 500;
  border-radius: var(--border-radius-md);
  box-shadow: var(--shadow-sm);
  color: var(--color-primary-button-text);
  background-color: var(--color-primary);
  cursor: pointer;
  transition: background-color 0.2s ease, box-shadow 0.2s ease;
}

.google-signin-button:hover {
  background-color: var(--color-primary-dark);
}

.google-signin-button:focus {
  outline: none;
  box-shadow: 0 0 0 2px var(--color-background), 0 0 0 4px var(--color-primary);
}

.google-icon {
  margin-right: var(--space-sm);
  font-weight: bold;
}
</style>

================
File: components/dashboard/Dashboard.vue
================
<template>
  <div class="dashboard-page">
    <div class="dashboard-header">
      <h1>Your Subscription Dashboard</h1>
      <AppButton @click="refreshEmails" :disabled="isLoading">
        <span v-if="isLoading">
          <AppSpinner style="width: 1em; height: 1em; border-width: 2px; margin-right: var(--space-sm);"/> Refreshing...
        </span>
        <span v-else>
          Refresh Emails
        </span>
      </AppButton>
    </div>

    <!-- Sync Status Message -->
    <div v-if="syncStatus" class="sync-status-message" :class="{'success': !syncError, 'error': syncError}">
      {{ syncStatus }}
    </div>

    <!-- Removed initial load spinner - handled by parent index page -->

    <!-- Dashboard Grid -->
    <div class="dashboard-grid">
      <AppCard title="Spending Overview" class="overview-card">
        <!-- TODO: Replace with actual data from composable -->
        <p>Total Monthly Spend: <strong>$XXX.XX</strong></p>
        <p>Total Yearly Spend: <strong>$YYYY.YY</strong></p>
        <div class="placeholder-chart" aria-label="Placeholder for spending chart">Chart Area</div>
      </AppCard>

      <AppCard title="Upcoming Renewals" class="renewals-card">
        <!-- Use subscriptions data from composable -->
        <ul v-if="subscriptions.length">
          <li v-for="sub in subscriptions" :key="sub.id">
             {{ sub.name }} - ${{ sub.cost.toFixed(2) }} - Renews {{ sub.next_renewal }}
          </li>
        </ul>
        <p v-else>No upcoming renewals found.</p>
        <template #footer>
          <NuxtLink to="/subscriptions">View all subscriptions</NuxtLink>
        </template>
      </AppCard>

      <AppCard title="Category Breakdown" class="category-card">
        <!-- TODO: Replace with actual data from composable -->
        <ul>
          <li>Streaming: $XX.XX</li>
          <li>Music: $YY.YY</li>
          <li>Cloud Services: $ZZ.ZZ</li>
        </ul>
         <div class="placeholder-chart small" aria-label="Placeholder for category breakdown chart">Chart Area</div>
      </AppCard>

    </div>

    <!-- Placeholder/Empty state if needed -->
    <!-- <div v-if="!isLoading && !subscriptions.length" class="empty-state"> ... </div> -->

  </div>
</template>

<script setup>
import { useDashboard } from '@/composables/useDashboard'
import AppButton from '~/components/ui/AppButton.vue'
import AppCard from '~/components/ui/AppCard.vue'
import AppSpinner from '~/components/ui/AppSpinner.vue'

// Get state and actions from the composable
const { subscriptions, isLoading, syncStatus, syncError, refreshEmails } = useDashboard()

// No need for user check here, parent `pages/index.vue` handles auth wall

</script>

<style scoped>

.dashboard-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: var(--space-xl);
  flex-wrap: wrap;
  gap: var(--space-md);
}

.dashboard-header h1 {
  font-size: var(--font-2xl);
  font-weight: 600;
  margin: 0;
}

.sync-status-message {
  margin-bottom: var(--space-lg);
  padding: var(--space-sm) var(--space-md);
  border-radius: var(--border-radius-sm);
  font-size: var(--font-sm);
  text-align: center;
}

.sync-status-message.success {
  background-color: #dcfce7; /* Example Success */
  border: 1px solid #86efac;
  color: #166534;
}

.sync-status-message.error {
  background-color: #fee2e2; /* Example Error */
  border: 1px solid #fca5a5;
  color: #991b1b;
}


.dashboard-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
  gap: var(--space-lg);
}

ul {
  list-style: none;
  padding: 0;
  margin: 0;
}

li {
  padding: var(--space-sm) 0;
  border-bottom: 1px solid var(--color-border);
}

li:last-child {
  border-bottom: none;
}

.renewals-card ul,
.category-card ul {
  margin-bottom: var(--space-md);
}

.renewals-card a {
  color: var(--color-accent);
  text-decoration: underline;
  text-underline-offset: 2px;
}

.placeholder-chart {
  height: 150px;
  background-color: #f3f4f6;
  display: flex;
  align-items: center;
  justify-content: center;
  color: var(--color-muted);
  border-radius: var(--border-radius-md);
  margin-top: var(--space-md);
  font-style: italic;
}

.placeholder-chart.small {
    height: 100px;
}

.empty-state {
  text-align: center;
  padding: var(--space-2xl);
  margin-top: var(--space-xl);
  border: 2px dashed var(--color-border);
  border-radius: var(--border-radius-lg);
}

.empty-illustration {
  max-width: 150px;
  margin: 0 auto var(--space-lg);
  opacity: 0.7;
}

.empty-state h2 {
  font-size: var(--font-xl);
  margin-bottom: var(--space-sm);
}

.empty-state p {
  color: var(--color-muted);
  margin-bottom: var(--space-lg);
}
</style>

================
File: components/ui/AppButton.vue
================
<template>
  <button class="app-button" :class="variantClass">
    <slot />
  </button>
</template>

<script setup>
import { computed } from 'vue'

const props = defineProps({
  variant: {
    type: String,
    default: 'primary', // e.g., primary, secondary, danger, ghost
  },
})

const variantClass = computed(() => {
  return `button-${props.variant}`;
})
</script>

<style scoped>
.app-button {
  display: inline-flex;
  align-items: center;
  justify-content: center;
  padding: var(--space-sm) var(--space-lg);
  border-radius: var(--border-radius-md);
  border: 1px solid transparent;
  font-weight: 500;
  font-size: var(--font-base);
  cursor: pointer;
  transition-property: background-color, border-color, color, box-shadow;
  transition-duration: var(--transition-duration);
  transition-timing-function: var(--transition-timing);
  white-space: nowrap;
  user-select: none;
  text-decoration: none; /* For links styled as buttons */
}

/* Primary Button (Default) */
.button-primary {
  background-color: var(--color-accent);
  color: var(--color-bg);
  border-color: var(--color-accent);
}

.button-primary:hover {
  background-color: var(--color-accent-hover);
  border-color: var(--color-accent-hover);
}

.button-primary:focus-visible {
  outline: 2px solid var(--color-accent);
  outline-offset: 2px;
}

/* Secondary Button */
.button-secondary {
  background-color: var(--color-bg);
  color: var(--color-accent);
  border-color: var(--color-accent);
}

.button-secondary:hover {
  background-color: #f0f0ff; /* Lighter accent shade */
}

.button-secondary:focus-visible {
  outline: 2px solid var(--color-accent);
  outline-offset: 2px;
}

/* Ghost Button */
.button-ghost {
  background-color: transparent;
  color: var(--color-accent);
  border-color: transparent;
}

.button-ghost:hover {
  background-color: #f0f0ff; /* Lighter accent shade */
}

.button-ghost:focus-visible {
  outline: 2px solid var(--color-accent);
  outline-offset: 2px;
}

/* Danger Button (Example) */
.button-danger {
  background-color: var(--color-error-text);
  color: var(--color-bg);
  border-color: var(--color-error-text);
}

.button-danger:hover {
  background-color: #991b1b; /* Darker error color */
  border-color: #991b1b;
}

.button-danger:focus-visible {
  outline: 2px solid var(--color-error-text);
  outline-offset: 2px;
}

/* Add styles for :active, :disabled states as needed */
.app-button:disabled {
  opacity: 0.6;
  cursor: not-allowed;
}
</style>

================
File: components/ui/AppCard.vue
================
<template>
  <div class="app-card">
    <div v-if="hasHeaderSlot || title" class="card-header">
      <slot name="header">
        <h3 v-if="title" class="card-title">{{ title }}</h3>
      </slot>
    </div>
    <div class="card-body">
      <slot />
    </div>
    <div v-if="hasFooterSlot" class="card-footer">
      <slot name="footer" />
    </div>
  </div>
</template>

<script setup>
import { useSlots } from 'vue'

const props = defineProps({
  title: {
    type: String,
    default: null,
  },
})

const slots = useSlots()
const hasHeaderSlot = computed(() => !!slots.header)
const hasFooterSlot = computed(() => !!slots.footer)
</script>

<style scoped>
.app-card {
  background-color: var(--color-bg);
  border-radius: var(--border-radius-lg);
  border: 1px solid var(--color-border);
  box-shadow: var(--box-shadow);
  overflow: hidden; /* Ensures content respects border-radius */
  transition: box-shadow var(--transition-duration) var(--transition-timing);
}

/* Optional: Add hover effect */
/*
.app-card:hover {
  box-shadow: var(--box-shadow-md);
}
*/

.card-header {
  padding: var(--space-md) var(--space-lg);
  border-bottom: 1px solid var(--color-border);
  background-color: #f9fafb; /* Slightly off-white header */
}

.card-title {
  font-size: var(--font-lg);
  font-weight: 600;
  color: var(--color-text);
  margin: 0; /* Reset heading margin */
}

.card-body {
  padding: var(--space-lg);
}

.card-footer {
  padding: var(--space-md) var(--space-lg);
  border-top: 1px solid var(--color-border);
  background-color: #f9fafb; /* Slightly off-white footer */
  font-size: var(--font-sm);
  color: var(--color-muted);
}
</style>

================
File: components/ui/AppSpinner.vue
================
<template>
  <div class="spinner-container" aria-busy="true" aria-live="polite">
    <div class="spinner"></div>
    <span class="sr-only">Loading...</span>
  </div>
</template>

<style scoped>
.spinner-container {
  display: flex;
  align-items: center;
  justify-content: center;
  /* Add height/width or positioning as needed where used */
}

.spinner {
  border: 4px solid rgba(0, 0, 0, 0.1);
  width: 36px;
  height: 36px;
  border-radius: 50%;
  border-left-color: var(--color-accent);

  animation: spin 1s ease infinite;
}

@keyframes spin {
  0% {
    transform: rotate(0deg);
  }
  100% {
    transform: rotate(360deg);
  }
}

/* Screen reader only text */
.sr-only {
  position: absolute;
  width: 1px;
  height: 1px;
  padding: 0;
  margin: -1px;
  overflow: hidden;
  clip: rect(0, 0, 0, 0);
  white-space: nowrap;
  border-width: 0;
}
</style>

================
File: components/ui/ErrorBanner.vue
================
<template>
  <div
    v-if="message"
    class="error-banner"
    role="alert"
  >
    <strong class="error-title">Error:</strong>
    <span class="error-message">{{ message }}</span>
  </div>
</template>

<script setup>
defineProps({
  message: {
    type: String,
    default: ''
  }
})
</script>

<style scoped>
.error-banner {
  background-color: var(--color-error-bg);
  border: 1px solid var(--color-error-border);
  color: var(--color-error-text);
  padding: var(--space-md) var(--space-lg);
  border-radius: var(--border-radius);
  position: relative;
}

.error-title {
  font-weight: bold;
  margin-right: var(--space-sm);
}

.error-message {
  display: inline-block;
}

/* Example media query if sm:inline behavior was crucial */
/* @media (min-width: 640px) { 
  .error-message {
    display: inline;
  }
} */
</style>

================
File: components/LogoutButton.vue
================
<template>
  <button
    @click="$emit('click')"
    class="logout-button"
  >
    Logout
  </button>
</template>

<script setup>
defineEmits(['click'])
</script>

<style scoped>
.logout-button {
  padding: 0.25rem 0.75rem; /* Approximates px-3 py-1 */
  border: 1px solid var(--color-border); /* Replaces border border-gray-300 */
  font-size: var(--font-sm); /* Replaces text-sm */
  font-weight: 500; /* Replaces font-medium */
  border-radius: var(--border-radius-md); /* Replaces rounded-md */
  color: var(--color-text-secondary); /* Replaces text-gray-700 */
  background-color: var(--color-button-secondary-bg); /* Replaces bg-white */
  cursor: pointer;
  transition: background-color 0.2s ease;
}

.logout-button:hover {
  background-color: var(--color-surface-hover); /* Replaces hover:bg-gray-50 */
}

.logout-button:focus {
  outline: none; /* Replaces focus:outline-none */
  box-shadow: 0 0 0 2px var(--color-background), 0 0 0 4px var(--color-primary); /* Replaces focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 */
}
</style>

================
File: composables/useDashboard.ts
================
import { ref, watchEffect } from 'vue'
import { useSupabaseUser, useSupabaseClient } from '#imports'

export function useDashboard () {
  // STATE
  const user = useSupabaseUser()
  const supabase = useSupabaseClient() // Needed for API calls
  const isLoading = ref(false)
  const syncStatus = ref('')
  const subscriptions = ref([]) // Placeholder for subscription data
  const syncError = ref(false) // Keep track of error state

  // ACTIONS
  async function refreshEmails () {
    if (import.meta.server) return // Guard against server-side execution

    isLoading.value = true
    syncStatus.value = 'Starting email sync...'
    syncError.value = false

    try {
      console.log('Calling /api/gmail/sync endpoint...')
      const response = await $fetch('/api/gmail/sync', { // Use $fetch directly
        method: 'POST',
        // No body needed unless API requires it
      })

      console.log('Gmail Sync API Response:', response)
      // Assuming response has a count or similar field
      syncStatus.value = `Sync successful! Processed emails.` // Update message based on actual API response structure
      // TODO: Refetch subscriptions after successful sync
      await loadSubscriptions() // Example: reload subscriptions

    } catch (error) {
      console.error('Error calling Gmail Sync API:', error)
      const data = error?.data // Nuxt $fetch error data
      const message = data?.message || data?.statusMessage || error?.message || 'An unknown error occurred during sync.'
      syncStatus.value = `Sync failed: ${message}`
      syncError.value = true

    } finally {
      isLoading.value = false
      // Optional: Auto-hide status after delay
      // setTimeout(() => { syncStatus.value = null }, 7000)
    }
  }

  // Placeholder for loading subscriptions - implement based on your data source
  async function loadSubscriptions () {
    if (!user.value) return // Don't load if no user

    // isLoading.value = true // Optionally show loading state for subscriptions
    console.log('Placeholder: Loading subscriptions for user:', user.value.id)
    // Example: Fetch from Supabase table
    // const { data, error } = await supabase
    //   .from('subscriptions')
    //   .select('*')
    //   .eq('user_id', user.value.id);
    //
    // if (error) {
    //   console.error('Error loading subscriptions:', error)
    //   syncStatus.value = `Error loading subscriptions: ${error.message}`
    //   syncError.value = true
    // } else {
    //   subscriptions.value = data
    // }
    // isLoading.value = false // Reset loading state
    subscriptions.value = [ // TEMPORARY DUMMY DATA
      { id: 1, name: 'Netflix', cost: 15.99, next_renewal: '2024-10-30', category: 'Streaming' },
      { id: 2, name: 'Spotify', cost: 10.99, next_renewal: '2024-11-05', category: 'Music' },
      { id: 3, name: 'AWS', cost: 25.00, next_renewal: '2024-11-01', category: 'Cloud Services' }
    ]
  }

  // INIT: Load subscriptions when user context is available or changes
  watchEffect(() => {
    if (user.value) {
      loadSubscriptions()
    } else {
      // Reset state if user logs out
      subscriptions.value = []
      syncStatus.value = ''
      isLoading.value = false
    }
  })

  return {
    user,
    isLoading,
    syncStatus,
    syncError,
    subscriptions,
    refreshEmails,
    loadSubscriptions // Expose if needed elsewhere
  }
}

================
File: layouts/default.vue
================
<template>
  <div class="app-layout">
    <header class="app-header">
      <div class="container header-container">
        <div class="logo">SubTracker</div>
        <nav class="navigation">
          <NuxtLink to="/">Dashboard</NuxtLink>
          <NuxtLink to="/settings">Settings</NuxtLink>
          <!-- Add more nav links as needed -->
        </nav>
        <div class="user-profile">
            <template v-if="user">
              <span>{{ user.email }}</span>
              <button @click="logout" class="logout-button">Logout</button>
            </template>
            <button v-else @click="login" class="login-button">Login</button>
        </div>
      </div>
    </header>

    <main class="main-content">
      <div class="container">
        <slot />
      </div>
    </main>

    <footer class="app-footer">
      <div class="container">
        <p>&copy; {{ new Date().getFullYear() }} SubTracker. All rights reserved.</p>
      </div>
    </footer>
  </div>
</template>

<script setup>
import { useSupabaseUser, useSupabaseClient } from '#imports'
import { navigateTo } from '#app'

const user = useSupabaseUser()
const supabase = useSupabaseClient()

const login = async () => {
  try {
    const { error } = await supabase.auth.signInWithOAuth({
      provider: 'google',
      options: {
        scopes: 'openid email profile https://www.googleapis.com/auth/gmail.readonly',
        redirectTo: `${window.location.origin}/auth/callback` // Ensure correct redirect
      }
    })
    if (error) throw error
  } catch (error) {
    console.error('Error during Google sign-in:', error)
    // Optionally show a user-facing error message
  }
}

const logout = async () => {
  try {
    const { error } = await supabase.auth.signOut()
    if (error) throw error
    await navigateTo('/login') // Navigate after successful logout
  } catch (error) {
    console.error('Error during sign-out:', error)
  }
}
</script>

================
File: layouts/minimal.vue
================
<template>
  <div>
    <slot />
  </div>
</template>

<script setup>
// Minimal layout - no specific script logic needed usually
</script>

<style scoped>
/* Add minimal styling if needed, e.g., basic padding */
div {
  /* Example: Add some padding around the content */
  /* padding: var(--space-lg); */
}
</style>

================
File: middleware/auth.global.ts
================
import { useSupabaseUser, navigateTo } from '#imports'
import { watch } from 'vue'

export default defineNuxtRouteMiddleware(async (to) => {
  // Skip middleware on these pages
  if (to.path === '/login' || to.path === '/auth/callback') {
    return
  }

  const user = useSupabaseUser()

  // If we're on the client and the user state isn't determined yet
  if (import.meta.client && user.value === undefined) {
    await new Promise<void>((resolve) => {
      const unwatch = watch(user, (newUser) => {
        if (newUser !== undefined) {
          unwatch()
          resolve()
        }
      }, { immediate: true })

      // Failsafe timeout
      setTimeout(() => {
        unwatch()
        resolve()
      }, 3000)
    })
  }

  // After user state is resolved, handle navigation
  if (!user.value) {
    return navigateTo('/login')
  }
})

================
File: pages/auth/callback.vue
================
<template>
  <div class="callback-container">
    <!-- 1. still-loading state -->
    <div v-if="loading" class="loading-state">
      <p>Completing signâ€‘inâ€¦</p>
    </div>

    <!-- 2. error state -->
    <div v-else-if="errorMessage" class="error-state">
      <ErrorBanner :message="errorMessage" class="error-banner-spacing" />
      <NuxtLink to="/login" class="retry-link">
        Retry Login
      </NuxtLink>
    </div>

    <!-- 3. success: instant redirect -->
    <div v-else>
      <p>Redirectingâ€¦</p>
    </div>
  </div>
</template>

<script setup lang="ts">
import { ref, watchEffect, onMounted } from 'vue'
import { useRoute } from 'vue-router'
import { useSupabaseUser } from '#imports'
import ErrorBanner from '~/components/ui/ErrorBanner.vue'

const route        = useRoute()
const user         = useSupabaseUser()

const loading      = ref(true)
const errorMessage = ref('')

/**
 * 1. If the module put ?error_description=â€¦ in the callback URL
 *    surface it and stop loading.
 */
onMounted(() => {
  const err = route.query.error_description as string | undefined
  if (err) {
    errorMessage.value = decodeURIComponent(err.replace(/\+/g, ' '))
    loading.value      = false
  }
})

/**
 * 2. When the automatic PKCE exchange finishes successfully,
 *    `useSupabaseUser()` becomes nonâ€‘null â†’ redirect.
 */
watchEffect(() => {
  // If user becomes truthy, the callback processing is likely done.
  // Supabase redirectOptions should handle the final navigation to '/'.
  // No explicit navigateTo needed here anymore.
  // if (user.value) {
  //   await navigateTo('/')
  // }

  // Handle error state
  if (route.query.error_description) {
    errorMessage.value = decodeURIComponent((route.query.error_description as string).replace(/\+/g, ' '))
    loading.value = false
  }

  // If still no user and no error, remain in loading state.
  // If user becomes truthy OR error is set, loading should become false.
  loading.value = !user.value && !errorMessage.value
})
</script>

<style scoped>
.callback-container {
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  min-height: 100vh; /* Replaces min-h-screen */
}

.loading-state,
.error-state {
  text-align: center; /* Replaces text-center */
}

.error-banner-spacing {
  margin-bottom: var(--space-lg); /* Replaces mb-4 */
}

.retry-link {
  color: var(--color-primary); /* Replaces text-indigo-600 */
  text-decoration: none;
}

.retry-link:hover {
  color: var(--color-primary-dark); /* Replaces hover:text-indigo-800, assuming a darker primary */
  text-decoration: underline;
}
</style>

================
File: pages/index.vue
================
<template>
  <div>
    <!-- Render Dashboard if user is logged in -->
    <Dashboard v-if="user" />
    <!-- Render LandingHero if user is not logged in -->
    <LandingHero v-else />
  </div>
</template>

<script setup>
import { useSupabaseUser } from '#imports'
// Use Nuxt's auto-import for components unless paths are complex/ambiguous
// import Dashboard from '@/components/dashboard/Dashboard.vue' // Auto-imported usually
// import LandingHero from '@/components/landing/Hero.vue' // Assuming path, adjust if needed

// Define layout (optional, Nuxt might infer 'default')
definePageMeta({
  layout: 'default',
})

// Get the user state
const user = useSupabaseUser()

// No need for login/logout/refresh logic here, it's handled by:
// - useDashboard (refresh)
// - LandingHero (login)
// - LogoutButton in the layout/header (logout)
</script>

<style scoped>
/* Remove all previous scoped styles */
/* Add any page-specific wrapper styles if needed, but likely none required */
</style>

================
File: pages/login.vue
================
<template>
  <div class="login-page">
    <div v-if="user">
      <p>You are already logged in. Redirecting to dashboard...</p>
      <!-- Optional: Add a spinner -->
    </div>
    <div v-else>
      <h1>Login Required</h1>
      <p>You need to sign in to access this application.</p>
      <ErrorBanner :message="errorMessage" class="error-banner-spacing" />
      <GoogleSignInButton @click="handleSignIn" :disabled="loading" />
      <div v-if="loading" class="loading-indicator">
         <AppSpinner /> <!-- Assuming AppSpinner component -->
        <p>Redirecting to Google...</p>
      </div>
    </div>
  </div>
</template>

<script setup>
import { ref, watchEffect } from 'vue'
import { useSupabaseClient, useSupabaseUser } from '#imports'
import { navigateTo } from '#app'
// Assuming components are auto-imported or imported like this:
import GoogleSignInButton from '~/components/auth/GoogleSignInButton.vue'
import ErrorBanner from '~/components/ui/ErrorBanner.vue'
import AppSpinner from '~/components/ui/AppSpinner.vue'

const supabase = useSupabaseClient()
const user = useSupabaseUser()

const loading = ref(false)
const errorMessage = ref('')

// Redirect if user is already logged in
watchEffect(() => {
  if (user.value) {
    navigateTo('/') // Redirect logged-in users to the main page (index/dashboard)
  }
})

async function handleSignIn() {
  loading.value = true
  errorMessage.value = ''
  try {
    const { error } = await supabase.auth.signInWithOAuth({
      provider: 'google',
      options: {
        scopes: 'openid email profile https://www.googleapis.com/auth/gmail.readonly',
        redirectTo: `${window.location.origin}/auth/callback`
      }
    })
    if (error) throw error
    // Redirect happens via Supabase
  } catch (error) {
    console.error('Error signing in from login page:', error)
    errorMessage.value = error.error_description || error.message || 'Login failed.'
    loading.value = false
  }
}

definePageMeta({
  layout: 'minimal' // Use a minimal layout if available, otherwise default
});
</script>

<style scoped>
.login-page {
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  min-height: 80vh; /* Adjust height as needed */
  text-align: center;
  padding: var(--space-lg);
}

.login-page h1 {
  font-size: var(--font-2xl);
  margin-bottom: var(--space-md);
}

.login-page p {
  color: var(--color-muted);
  margin-bottom: var(--space-lg);
}

/* Added styles */
.error-banner-spacing {
  margin-bottom: var(--space-lg); /* Replaces mb-4 */
}

.loading-indicator {
  margin-top: var(--space-lg); /* Replaces mt-4 */
  text-align: center; /* Replaces text-center */
}

/* Assuming GoogleSignInButton might need some margin */
.google-signin-button {
  margin-top: var(--space-md);
}

</style>

================
File: pages/settings.vue
================
<template>
  <div>
    <!-- Use the same header or a dedicated settings layout header -->
    <header class="settings-header">
       <h1 class="settings-title">Settings</h1>
       <!-- Optional: Add navigation back to dashboard or user info -->
       <NuxtLink to="/dashboard" class="back-link">Back to Dashboard</NuxtLink>
    </header>

    <main class="settings-main">
      <!-- Section: Re-Consent Gmail Access -->
      <section class="settings-section">
        <h2 class="section-title">Gmail Access</h2>
        <div v-if="needsReGrant" class="regrant-notice">
          <p>Gmail access scope might be missing or revoked. Grant access to enable email scanning.</p>
          <button
            @click="handleReConsent"
            class="regrant-button"
            :disabled="loadingReconsent"
           >
             {{ loadingReconsent ? 'Processing...' : 'Grant Gmail Access' }}
          </button>
           <p v-if="reconsentError" class="reconsent-error">{{ reconsentError }}</p>
        </div>
        <div v-else>
          <p class="access-granted">Gmail read-only access is currently granted.</p>
          <!-- Optional: Add button to revoke? Requires careful handling -->
        </div>
      </section>

      <!-- Section: Session Info -->
      <section class="settings-section">
        <h2 class="section-title">Session Information</h2>
        <div v-if="sessionInfo">
          <p><strong>User ID:</strong> {{ sessionInfo.user?.id }}</p>
          <p><strong>Email:</strong> {{ sessionInfo.user?.email }}</p>
          <p><strong>Expires At:</strong> {{ sessionInfo.expires_at ? new Date(sessionInfo.expires_at * 1000).toLocaleString() : 'N/A' }}</p>
          <p><strong>Granted Scopes:</strong></p>
          <!-- Displaying scopes requires parsing the access token or having metadata. -->
          <!-- Supabase provider_token doesn't directly expose scopes easily client-side -->
          <ul class="scope-list">
            <li>openid</li>
            <li>email</li>
            <li>profile</li>
            <li :class="['scope-item', { 'scope-granted': hasGmailScope, 'scope-missing': !hasGmailScope }]">
               https://www.googleapis.com/auth/gmail.readonly {{ hasGmailScope ? '(Granted)' : '(Missing/Revoked?)' }}
            </li>
            <!-- Note: This scope list is assumed based on login request -->
          </ul>
        </div>
        <div v-else>
          <p>Loading session information...</p>
        </div>
         <button
            @click="refreshSessionInfo"
            class="refresh-session-button"
            :disabled="loadingSession"
         >
           {{ loadingSession ? 'Refreshing...' : 'Refresh Session' }}
         </button>
      </section>

       <!-- Section: Digest Preferences (Placeholder from prd2.md) -->
       <section class="settings-section">
         <h2 class="section-title">Digest Preferences</h2>
         <p>Configure email digest frequency (Monthly, Weekly, Off).</p>
         <!-- Placeholder for <DigestPrefsForm> -->
         <div class="prefs-placeholder">
           (Digest preference form TBD)
         </div>
       </section>

    </main>
  </div>
</template>

<script setup>
import { ref, onMounted, watchEffect } from 'vue' // Removed unused 'computed'
// import { useSupabaseClient, useSupabaseUser } from '#supabase/client' // Removed - rely on auto-import
import { useRouter } from 'vue-router'
import { useSupabaseClient } from '#imports'

const supabase = useSupabaseClient()
const user = useSupabaseUser()

const sessionInfo = ref(null)
const needsReGrant = ref(false) // Will be updated based on scope check
const hasGmailScope = ref(false) // Derived from session check
const loadingSession = ref(false)
const loadingReconsent = ref(false)
const reconsentError = ref('')

async function fetchSessionData() {
  loadingSession.value = true
  const { data, error } = await supabase.auth.getSession()
  if (error) {
    console.error('Error fetching session:', error)
    sessionInfo.value = { error: error.message }
  } else if (data.session) {
    sessionInfo.value = {
        user: data.session.user,
        expires_at: data.session.expires_at,
        // provider_token: data.session.provider_token, // Use cautiously
        // access_token: data.session.access_token // Use cautiously
    }
    // Placeholder Check for Gmail Scope:
    // This is a simplified check. A robust solution might involve:
    // 1. Decoding the access_token (if JWT) client-side (less secure, exposes token)
    // 2. Calling a secure backend endpoint that verifies the token with Google.
    // 3. Storing granted scopes in user_metadata upon login/refresh via an Edge Function/Hook.
    // Assuming for now: if provider_token exists, scope *might* be okay.
    hasGmailScope.value = !!data.session.provider_token; // VERY BASIC CHECK
    needsReGrant.value = !hasGmailScope.value;

  } else {
     sessionInfo.value = null; // No active session
     needsReGrant.value = true; // Assume regrant needed if no session
     hasGmailScope.value = false;
  }
  loadingSession.value = false
}

function refreshSessionInfo() {
    fetchSessionData();
}

async function handleReConsent() {
  loadingReconsent.value = true
  reconsentError.value = ''
  try {
    // Use the same signInWithOAuth function as the login page
    const { error } = await supabase.auth.signInWithOAuth({
      provider: 'google',
      options: {
        scopes: 'openid email profile https://www.googleapis.com/auth/gmail.readonly',
        // Crucially, Google might automatically skip consent if already granted
        // or prompt only for the missing scope.
        // redirectTo: `${window.location.origin}/settings` // Redirect back to settings?
      }
    })
    if (error) throw error
    // Redirect might happen, or page might reload/re-render. Watch for session changes.
  } catch (error) {
    console.error('Error during re-consent:', error)
    reconsentError.value = error.error_description || error.message || 'Failed to re-grant access.'
  } finally {
      loadingReconsent.value = false
      // Re-fetch session data after attempt
      // Might need a slight delay or rely on auth watcher
      setTimeout(fetchSessionData, 1000);
  }
}

onMounted(() => {
  fetchSessionData()

  // Redirect to login if user is not authenticated
   watchEffect(() => {
       if (!user.value) {
           const router = useRouter()
           router.push('/login')
       }
   })
});

// Optional: Define layout
// definePageMeta({ layout: 'default' });
</script>

<style scoped>
.settings-header {
  display: flex;
  justify-content: space-between; /* Replaces justify-between */
  align-items: center; /* Replaces items-center */
  padding: var(--space-lg); /* Replaces p-4 */
  border-bottom: 1px solid var(--color-border); /* Replaces border-b */
}

.settings-title {
  font-size: var(--font-xl); /* Replaces text-xl */
  font-weight: 600; /* Replaces font-semibold */
}

.back-link {
  color: var(--color-primary); /* Replaces text-indigo-600 */
  text-decoration: none;
}

.back-link:hover {
  color: var(--color-primary-dark); /* Replaces hover:text-indigo-800 */
  text-decoration: underline;
}

.settings-main {
  padding: var(--space-xl); /* Replaces p-6 */
  display: flex;
  flex-direction: column;
  gap: var(--space-xl); /* Replaces space-y-6 */
}

.settings-section {
  padding: var(--space-lg); /* Replaces p-4 */
  border: 1px solid var(--color-border);
  border-radius: var(--border-radius); /* Replaces rounded */
  box-shadow: var(--shadow-sm); /* Replaces shadow */
}

.section-title {
  font-size: var(--font-lg); /* Replaces text-lg */
  font-weight: 500; /* Replaces font-medium */
  margin-bottom: var(--space-md); /* Replaces mb-3 */
}

.regrant-notice {
  background-color: var(--color-warning-bg); /* Replaces bg-yellow-100 */
  border: 1px solid var(--color-warning-border); /* Replaces border-yellow-400 */
  color: var(--color-warning-text); /* Replaces text-yellow-700 */
  padding: var(--space-md) var(--space-lg); /* Replaces px-4 py-3 */
  border-radius: var(--border-radius); /* Replaces rounded */
  position: relative; /* Replaces relative */
  margin-bottom: var(--space-lg); /* Replaces mb-4 */
}

.regrant-button {
  margin-top: var(--space-sm); /* Replaces mt-2 */
  padding: 0.25rem 0.75rem; /* Approximates px-3 py-1 */
  background-color: var(--color-warning); /* Replaces bg-yellow-500 */
  color: var(--color-warning-button-text); /* Replaces text-white */
  border: none;
  border-radius: var(--border-radius); /* Replaces rounded */
  cursor: pointer;
  transition: background-color 0.2s ease;
}

.regrant-button:hover {
  background-color: var(--color-warning-dark); /* Replaces hover:bg-yellow-600 */
}

.regrant-error {
  color: var(--color-error); /* Replaces text-red-600 */
  font-size: var(--font-sm); /* Replaces text-sm */
  margin-top: var(--space-xs); /* Replaces mt-1 */
}

.access-granted {
  color: var(--color-success); /* Replaces text-green-700 */
}

.scope-list {
  list-style: disc; /* Replaces list-disc */
  margin-left: var(--space-lg); /* Replaces ml-4 */
  padding-left: var(--space-md); /* Replaces list-inside - approximates behavior */
  font-size: var(--font-sm); /* Replaces text-sm */
}

.scope-item {
  /* Base style for list items */
}

.scope-granted {
  color: var(--color-success); /* Replaces text-green-700 */
  font-weight: 600; /* Replaces font-semibold */
}

.scope-missing {
  color: var(--color-error); /* Replaces text-red-600 */
}

.refresh-session-button {
  margin-top: var(--space-md); /* Replaces mt-3 */
  padding: 0.25rem 0.75rem; /* Approximates px-3 py-1 */
  border: 1px solid var(--color-border); /* Replaces border border-gray-300 */
  font-size: var(--font-sm); /* Replaces text-sm */
  border-radius: var(--border-radius); /* Replaces rounded */
  cursor: pointer;
  transition: background-color 0.2s ease;
}

.refresh-session-button:hover {
  background-color: var(--color-surface-hover); /* Replaces hover:bg-gray-50 */
}

.prefs-placeholder {
  margin-top: var(--space-sm); /* Replaces mt-2 */
  color: var(--color-muted); /* Replaces text-gray-500 */
}
</style>

================
File: public/google-logo.svg
================
<?xml version="1.0" ?><svg id="Capa_1" style="enable-background:new 0 0 150 150;" version="1.1" viewBox="0 0 150 150" xml:space="preserve" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><style type="text/css">
	.st0{fill:#1A73E8;}
	.st1{fill:#EA4335;}
	.st2{fill:#4285F4;}
	.st3{fill:#FBBC04;}
	.st4{fill:#34A853;}
	.st5{fill:#4CAF50;}
	.st6{fill:#1E88E5;}
	.st7{fill:#E53935;}
	.st8{fill:#C62828;}
	.st9{fill:#FBC02D;}
	.st10{fill:#1565C0;}
	.st11{fill:#2E7D32;}
	.st12{fill:#F6B704;}
	.st13{fill:#E54335;}
	.st14{fill:#4280EF;}
	.st15{fill:#34A353;}
	.st16{clip-path:url(#SVGID_2_);}
	.st17{fill:#188038;}
	.st18{opacity:0.2;fill:#FFFFFF;enable-background:new    ;}
	.st19{opacity:0.3;fill:#0D652D;enable-background:new    ;}
	.st20{clip-path:url(#SVGID_4_);}
	.st21{opacity:0.3;fill:url(#_45_shadow_1_);enable-background:new    ;}
	.st22{clip-path:url(#SVGID_6_);}
	.st23{fill:#FA7B17;}
	.st24{opacity:0.3;fill:#174EA6;enable-background:new    ;}
	.st25{opacity:0.3;fill:#A50E0E;enable-background:new    ;}
	.st26{opacity:0.3;fill:#E37400;enable-background:new    ;}
	.st27{fill:url(#Finish_mask_1_);}
	.st28{fill:#FFFFFF;}
	.st29{fill:#0C9D58;}
	.st30{opacity:0.2;fill:#004D40;enable-background:new    ;}
	.st31{opacity:0.2;fill:#3E2723;enable-background:new    ;}
	.st32{fill:#FFC107;}
	.st33{opacity:0.2;fill:#1A237E;enable-background:new    ;}
	.st34{opacity:0.2;}
	.st35{fill:#1A237E;}
	.st36{fill:url(#SVGID_7_);}
	.st37{fill:#FBBC05;}
	.st38{clip-path:url(#SVGID_9_);fill:#E53935;}
	.st39{clip-path:url(#SVGID_11_);fill:#FBC02D;}
	.st40{clip-path:url(#SVGID_13_);fill:#E53935;}
	.st41{clip-path:url(#SVGID_15_);fill:#FBC02D;}
</style><g><path class="st14" d="M120,76.1c0-3.1-0.3-6.3-0.8-9.3H75.9v17.7h24.8c-1,5.7-4.3,10.7-9.2,13.9l14.8,11.5   C115,101.8,120,90,120,76.1L120,76.1z"/><path class="st15" d="M75.9,120.9c12.4,0,22.8-4.1,30.4-11.1L91.5,98.4c-4.1,2.8-9.4,4.4-15.6,4.4c-12,0-22.1-8.1-25.8-18.9   L34.9,95.6C42.7,111.1,58.5,120.9,75.9,120.9z"/><path class="st12" d="M50.1,83.8c-1.9-5.7-1.9-11.9,0-17.6L34.9,54.4c-6.5,13-6.5,28.3,0,41.2L50.1,83.8z"/><path class="st13" d="M75.9,47.3c6.5-0.1,12.9,2.4,17.6,6.9L106.6,41C98.3,33.2,87.3,29,75.9,29.1c-17.4,0-33.2,9.8-41,25.3   l15.2,11.8C53.8,55.3,63.9,47.3,75.9,47.3z"/></g></svg>

================
File: public/robots.txt
================
User-Agent: *
Disallow:

================
File: server/tsconfig.json
================
{
  "extends": "../.nuxt/tsconfig.server.json"
}

================
File: .gitignore
================
# Nuxt dev/build outputs
.output
.data
.nuxt
.nitro
.cache
dist

# Node dependencies
node_modules

# Logs
logs
*.log

# Misc
.DS_Store
.fleet
.idea

# Local env files
.env
.env.*
!.env.example

================
File: .repomixignore
================
# Add patterns to ignore here, one per line
# Example:
# *.log
# tmp/

================
File: app.vue
================
<template>
  <div>
    <NuxtLayout>
      <NuxtPage />
    </NuxtLayout>
  </div>
</template>

<style>
</style>

================
File: eslint.config.mjs
================
// @ts-check
import withNuxt from './.nuxt/eslint.config.mjs'

export default withNuxt(
  // Your custom configs here
)

================
File: nuxt.config.ts
================
// https://nuxt.com/docs/api/configuration/nuxt-config
export default defineNuxtConfig({
  compatibilityDate: '2024-11-01',
  devtools: { enabled: true },

  css: [
    '~/assets/css/global.css', 
    '~/assets/css/layout.css',     
  ],
  runtimeConfig: {
    // Private keys are only available on the server
    // supabaseServiceKey: process.env.SUPABASE_SERVICE_KEY,
    // Public keys that are exposed to the client, prefix with 'public'
    public: {
      supabaseUrl: process.env.SUPABASE_URL,
      supabaseKey: process.env.SUPABASE_KEY,
    }
  },

  modules: [
    '@nuxtjs/supabase',
    '@nuxt/eslint',
    '@nuxt/icon',
    '@nuxt/image',
    '@nuxt/scripts'
  ],

  supabase: {
    url: process.env.SUPABASE_URL,
    key: process.env.SUPABASE_KEY,
    clientOptions: {
      auth: {
        flowType: 'pkce',          // generate verifier + challenge
        detectSessionInUrl: true,  // autoâ€‘exchange on first paint
        persistSession: true,
      },
    },
    redirectOptions: {
      login: '/login',
      callback: '/',
      exclude: [],
    }
  }
})

================
File: package.json
================
{
  "name": "nuxt-app",
  "private": true,
  "type": "module",
  "scripts": {
    "build": "nuxt build",
    "dev": "nuxt dev",
    "generate": "nuxt generate",
    "preview": "nuxt preview",
    "postinstall": "nuxt prepare"
  },
  "dependencies": {
    "@nuxt/eslint": "^1.3.0",
    "@nuxt/icon": "^1.12.0",
    "@nuxt/image": "^1.10.0",
    "@nuxt/scripts": "^0.11.6",
    "@supabase/supabase-js": "^2.49.4",
    "@unhead/vue": "^2.0.8",
    "eslint": "^9.24.0",
    "nuxt": "^3.16.2",
    "vue": "^3.5.13",
    "vue-router": "^4.5.0"
  },
  "devDependencies": {
    "@nuxtjs/supabase": "^1.5.0"
  }
}

================
File: README.md
================
# Nuxt Minimal Starter

Look at the [Nuxt documentation](https://nuxt.com/docs/getting-started/introduction) to learn more.

## Setup

Make sure to install dependencies:

```bash
# npm
npm install

# pnpm
pnpm install

# yarn
yarn install

# bun
bun install
```

## Development Server

Start the development server on `http://localhost:3000`:

```bash
# npm
npm run dev

# pnpm
pnpm dev

# yarn
yarn dev

# bun
bun run dev
```

## Production

Build the application for production:

```bash
# npm
npm run build

# pnpm
pnpm build

# yarn
yarn build

# bun
bun run build
```

Locally preview production build:

```bash
# npm
npm run preview

# pnpm
pnpm preview

# yarn
yarn preview

# bun
bun run preview
```

Check out the [deployment documentation](https://nuxt.com/docs/getting-started/deployment) for more information.

================
File: repomix.config.json
================
{
  "output": {
    "filePath": "repomix-output.txt",
    "style": "plain",
    "parsableStyle": false,
    "fileSummary": true,
    "directoryStructure": true,
    "removeComments": false,
    "removeEmptyLines": false,
    "topFilesLength": 5,
    "showLineNumbers": false,
    "copyToClipboard": false
  },
  "include": [],
  "ignore": {
    "useGitignore": true,
    "useDefaultPatterns": true,
    "customPatterns": []
  },
  "security": {
    "enableSecurityCheck": true
  },
  "tokenCount": {
    "encoding": "o200k_base"
  }
}

================
File: tsconfig.json
================
{
  // https://nuxt.com/docs/guide/concepts/typescript
  "extends": "./.nuxt/tsconfig.json"
}
